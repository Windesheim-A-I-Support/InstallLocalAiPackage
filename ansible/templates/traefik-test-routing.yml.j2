# Traefik Dynamic Configuration for TEST AI Stack
# Target: {{ ansible_host }}
# Generated by Ansible

http:
  # ==========================================
  # ROUTERS - TEST ENVIRONMENT
  # ==========================================
  routers:
    test-openwebui-router:
      rule: "Host(`test-openwebui.{{ base_domain }}`)"
      service: test-openwebui-service
      entryPoints: [websecure]
      tls:
        certResolver: myresolver

    test-n8n-router:
      rule: "Host(`test-n8n.{{ base_domain }}`)"
      service: test-n8n-service
      entryPoints: [websecure]
      tls:
        certResolver: myresolver

    test-flowise-router:
      rule: "Host(`test-flowise.{{ base_domain }}`)"
      service: test-flowise-service
      entryPoints: [websecure]
      tls:
        certResolver: myresolver

    test-langfuse-router:
      rule: "Host(`test-langfuse.{{ base_domain }}`)"
      service: test-langfuse-service
      entryPoints: [websecure]
      tls:
        certResolver: myresolver

    test-neo4j-router:
      rule: "Host(`test-neo4j.{{ base_domain }}`)"
      service: test-neo4j-service
      entryPoints: [websecure]
      tls:
        certResolver: myresolver

    test-searxng-router:
      rule: "Host(`test-searxng.{{ base_domain }}`)"
      service: test-searxng-service
      entryPoints: [websecure]
      tls:
        certResolver: myresolver

    test-minio-router:
      rule: "Host(`test-minio.{{ base_domain }}`)"
      service: test-minio-service
      entryPoints: [websecure]
      tls:
        certResolver: myresolver

    test-supabase-router:
      rule: "Host(`test-supabase.{{ base_domain }}`)"
      service: test-supabase-service
      entryPoints: [websecure]
      tls:
        certResolver: myresolver

  # ==========================================
  # SERVICES - TEST ENVIRONMENT
  # ==========================================
  services:
    test-openwebui-service:
      loadBalancer:
        servers:
          - url: "http://{{ ansible_host }}:{{ open_webui_port }}"

    test-n8n-service:
      loadBalancer:
        servers:
          - url: "http://{{ ansible_host }}:{{ n8n_port }}"

    test-flowise-service:
      loadBalancer:
        servers:
          - url: "http://{{ ansible_host }}:{{ flowise_port }}"

    test-langfuse-service:
      loadBalancer:
        servers:
          - url: "http://{{ ansible_host }}:{{ langfuse_port }}"

    test-neo4j-service:
      loadBalancer:
        servers:
          - url: "http://{{ ansible_host }}:{{ neo4j_http_port }}"

    test-searxng-service:
      loadBalancer:
        servers:
          - url: "http://{{ ansible_host }}:{{ searxng_port }}"

    test-minio-service:
      loadBalancer:
        servers:
          - url: "http://{{ ansible_host }}:{{ minio_port }}"

    test-supabase-service:
      loadBalancer:
        servers:
          - url: "http://{{ ansible_host }}:{{ supabase_port }}"

# ==========================================
# TCP ROUTERS - TEST ENVIRONMENT
# ==========================================
tcp:
  routers:
    test-neo4j-bolt-router:
      rule: "HostSNI(`test-neo4j.{{ base_domain }}`)"
      service: test-neo4j-bolt-service
      entryPoints: [neo4j-bolt]
      tls:
        certResolver: myresolver
        passthrough: false

  services:
    test-neo4j-bolt-service:
      loadBalancer:
        servers:
          - address: "{{ ansible_host }}:{{ neo4j_bolt_port }}"
